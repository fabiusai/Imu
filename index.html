<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilazione F24 IMU - AI Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1976d2;
            --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            --surface: #ffffff;
            --border: #d1d5db;
            --text: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 15px;
            color: var(--text);
            font-size: 14px; /* Base font size slightly smaller for compactness */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* --- Header & Controls --- */
        .header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.4rem; font-weight: 500; }
        
        .controls {
            padding: 10px 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sheet-selector { flex-grow: 1; min-width: 200px; }
        select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-prompt { background: #f59e0b; }
        .btn-ai { background: #8b5cf6; }
        .btn-export { background: #10b981; }
        .btn-reset { background: #ef4444; }

        /* --- Content Layout --- */
        .content { padding: 20px; }

        .section {
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
            background: #fff;
        }

        .section-header {
            background: #f1f5f9;
            padding: 8px 15px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: #475569;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .section-body { padding: 15px; }

        /* --- Compact Form Grid --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Compact columns */
            gap: 12px 15px; /* Tighter gap */
        }

        .form-group { position: relative; }
        
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 3px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        /* Inputs styled for copy button */
        .form-input {
            width: 100%;
            padding: 8px 35px 8px 10px; /* Right padding for button */
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.95rem;
            height: 36px;
            transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1); }

        /* Copy Button */
        .copy-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .copy-btn:hover { color: var(--primary); background: #f0f9ff; }
        .copy-btn.copied { color: #10b981; }

        /* --- Table Styling --- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; font-size: 0.9rem; }
        
        th { 
            background: #f8fafc; 
            padding: 8px; 
            text-align: left; 
            font-weight: 600; 
            color: #475569; 
            border-bottom: 2px solid var(--border);
            font-size: 0.75rem;
        }
        
        td { padding: 6px 8px; border-bottom: 1px solid #f1f5f9; }
        
        /* Table Inputs */
        td input { 
            width: 100%; 
            padding: 6px; 
            border: 1px solid #e2e8f0; 
            border-radius: 3px;
            font-size: 0.9rem;
            text-align: center;
        }
        td input:focus { border-color: var(--primary); outline: none; }
        
        .currency-input { text-align: right; font-family: monospace; font-weight: 600; color: #334155; }

        /* --- Totals --- */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 15px;
        }
        .total-box {
            background: #f8fafc;
            padding: 10px 20px;
            border-radius: 6px;
            text-align: right;
            border: 1px solid var(--border);
            min-width: 150px;
        }
        .total-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .total-value { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-top: 2px; }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
        textarea {
            width: 100%; height: 200px; padding: 10px;
            border: 1px solid var(--border); border-radius: 4px;
            font-family: monospace; font-size: 0.85rem; background: #f8fafc;
        }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

        /* Notification Toast */
        .notification {
            position: fixed; top: 20px; right: 20px;
            padding: 10px 20px; border-radius: 4px; color: white;
            transform: translateY(-100px); transition: transform 0.3s;
            z-index: 2000; font-weight: 500; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .notification.show { transform: translateY(0); }
        .success { background: #10b981; }
        .error { background: #ef4444; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h1>Compilazione F24 IMU</h1>
                <span style="font-size: 0.8rem; opacity: 0.8; font-weight: normal;">AI Enhanced & Compact</span>
            </div>
        </div>

        <div class="controls">
            <div class="sheet-selector">
                <select id="personSelector" onchange="renderCurrentPerson()">
                    <option value="0">Contribuente 1</option>
                </select>
            </div>
            
            <button class="btn btn-prompt" onclick="openPromptModal()">ðŸ“‹ Ottieni Prompt</button>
            <button class="btn btn-ai" onclick="openImportModal()">âœ¨ Importa JSON</button>
            <button class="btn btn-export" onclick="exportToExcel()">ðŸ“Š Esporta Excel</button>
            <button class="btn btn-reset" onclick="resetApp()">ðŸ”„ Reset</button>
        </div>

        <div class="content" id="formContent">
            </div>
    </div>

    <div class="modal" id="promptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Prompt per Gemini</h3>
                <button class="close-modal" onclick="closePromptModal()">Ã—</button>
            </div>
            <p style="color: #64748b; font-size: 0.85rem;">Copia, allega i PDF in Gemini e incolla.</p>
            <textarea id="promptText" readonly>Agisci come un motore di estrazione dati per moduli fiscali.
Analizza i file PDF allegati (moduli F24). Per ogni PDF, estrai i dati nel seguente formato JSON rigoroso.

Devi generare un SINGOLO Array JSON contenente un oggetto per ogni persona/PDF analizzato.
Non includere markdown ```json o altro testo, solo il codice JSON puro.

Regole di formattazione:
1. Le date di nascita devono essere in formato YYYY-MM-DD.
2. Gli importi monetari (debito/credito) devono essere stringhe con la virgola come separatore decimale (es: "494,00"). Se vuoto, usa "0,00".
3. Se un campo nel PDF Ã¨ vuoto, usa una stringa vuota "".
4. Estrai solo le righe della sezione IMU (Sezione IMU E ALTRI TRIBUTI LOCALI).

Struttura JSON richiesta:
[
  {
    "codiceFiscale": "CODICE_FISCALE",
    "datiAnagrafici": {
      "nome": "NOME",
      "cognome": "COGNOME",
      "dataNascita": "YYYY-MM-DD",
      "sesso": "M/F",
      "comuneNascita": "COMUNE"
    },
    "domicilioFiscale": {
      "comune": "COMUNE",
      "provincia": "XX",
      "indirizzo": "INDIRIZZO COMPLETO"
    },
    "imuRows": [
      {
        "codiceEnte": "COD",
        "ravv": "",
        "immobVariati": "",
        "acconto": "",
        "saldo": "",
        "numeroImmobili": "1",
        "codiceTributo": "COD",
        "rateazione": "",
        "annoRiferimento": "2025",
        "importiDebito": "0,00",
        "importiCredito": "0,00"
      }
    ]
  }
]</textarea>
            <div class="modal-actions">
                <button class="btn btn-prompt" onclick="copyPromptToClipboard()">Copia Prompt</button>
            </div>
        </div>
    </div>

    <div class="modal" id="jsonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Incolla JSON da Gemini</h3>
                <button class="close-modal" onclick="closeImportModal()">Ã—</button>
            </div>
            <textarea id="jsonInput" placeholder='[{"codiceFiscale": "...", ...}]'></textarea>
            <div class="modal-actions">
                <button class="btn btn-ai" onclick="processJSON()">Importa Dati</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let appData = []; 
        const DEFAULT_PERSON = {
            codiceFiscale: '',
            datiAnagrafici: { nome: '', cognome: '', dataNascita: '', sesso: '', comuneNascita: '' },
            domicilioFiscale: { comune: '', provincia: '', indirizzo: '' },
            imuRows: Array(4).fill().map(() => ({
                codiceEnte: '', ravv: '', immobVariati: '', acconto: '', saldo: '', 
                numeroImmobili: '', codiceTributo: '', rateazione: '', annoRiferimento: '', 
                importiDebito: '0,00', importiCredito: '0,00'
            }))
        };

        appData = [JSON.parse(JSON.stringify(DEFAULT_PERSON))];

        // --- Core Functions ---
        function init() { renderCurrentPerson(); }

        function getActiveIndex() { return parseInt(document.getElementById('personSelector').value) || 0; }

        const Money = {
            parse: (str) => {
                if (!str) return 0;
                if (typeof str === 'number') return str;
                let clean = str.toString().replace(/\./g, '').replace(',', '.');
                return parseFloat(clean) || 0;
            },
            format: (num) => num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
        };

        function updateData(path, value, rowIndex = null) {
            const index = getActiveIndex();
            if (rowIndex !== null) {
                appData[index].imuRows[rowIndex][path] = value;
                if (path === 'importiDebito' || path === 'importiCredito') calculateTotals();
            } else if (path.includes('.')) {
                const [section, field] = path.split('.');
                appData[index][section][field] = value;
            } else {
                appData[index][path] = value;
            }
        }

        function calculateTotals() {
            const index = getActiveIndex();
            let totDebito = 0;
            let totCredito = 0;
            appData[index].imuRows.forEach(row => {
                totDebito += Money.parse(row.importiDebito);
                totCredito += Money.parse(row.importiCredito);
            });
            document.getElementById('displayTotaleG').textContent = Money.format(totDebito);
            document.getElementById('displaySaldo').textContent = Money.format(totDebito - totCredito);
        }

        // --- Copy to Clipboard Functionality ---
        function copyToClipboard(value, btn) {
            navigator.clipboard.writeText(value).then(() => {
                // Visual feedback
                const originalHtml = btn.innerHTML;
                btn.innerHTML = 'âœ“';
                btn.classList.add('copied');
                
                // Show toast
                showNotification('Copiato!', 'success');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('copied');
                }, 1500);
            }).catch(err => {
                showNotification('Errore copia', 'error');
            });
        }

        // --- Rendering Logic with Copy Buttons ---
        function renderCurrentPerson() {
            const index = getActiveIndex();
            const data = appData[index];
            const container = document.getElementById('formContent');

            // Helper to create compact input with copy button
            const createInput = (label, value, path, type = 'text', width = '100%') => `
                <div class="form-group" style="grid-column: span ${width === '100%' ? '2' : '1'}">
                    <label class="form-label">${label}</label>
                    <div class="input-wrapper">
                        <input type="${type}" class="form-input" value="${value}" 
                               oninput="updateData('${path}', this.value)">
                        <button class="copy-btn" onclick="copyToClipboard('${value}', this)" title="Copia">ðŸ“‹</button>
                    </div>
                </div>
            `;
            
            // Special helper for select
            const createSelect = (label, value, path, options) => `
                <div class="form-group">
                    <label class="form-label">${label}</label>
                    <div class="input-wrapper">
                        <select class="form-input" onchange="updateData('${path}', this.value)">
                            ${options.map(opt => `<option value="${opt.val}" ${value === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                        </select>
                         <button class="copy-btn" onclick="copyToClipboard('${value}', this)" title="Copia">ðŸ“‹</button>
                    </div>
                </div>
            `;

            container.innerHTML = `
                <div class="section">
                    <div class="section-header">Dati Anagrafici</div>
                    <div class="section-body form-grid">
                        ${createInput('Codice Fiscale', data.codiceFiscale, 'codiceFiscale')}
                        ${createInput('Cognome', data.datiAnagrafici.cognome, 'datiAnagrafici.cognome')}
                        ${createInput('Nome', data.datiAnagrafici.nome, 'datiAnagrafici.nome')}
                        ${createInput('Data Nascita', data.datiAnagrafici.dataNascita, 'datiAnagrafici.dataNascita', 'date')}
                        ${createInput('Comune Nascita', data.datiAnagrafici.comuneNascita, 'datiAnagrafici.comuneNascita')}
                        ${createSelect('Sesso', data.datiAnagrafici.sesso, 'datiAnagrafici.sesso', [{val:'',label:'-'},{val:'M',label:'M'},{val:'F',label:'F'}])}
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">Domicilio Fiscale</div>
                    <div class="section-body form-grid">
                        ${createInput('Comune', data.domicilioFiscale.comune, 'domicilioFiscale.comune')}
                        ${createInput('Provincia', data.domicilioFiscale.provincia, 'domicilioFiscale.provincia')}
                        ${createInput('Indirizzo', data.domicilioFiscale.indirizzo, 'domicilioFiscale.indirizzo')}
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">Sezione IMU e Tributi Locali</div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 80px">Cod. Ente</th>
                                    <th style="width: 50px">Ravv.</th>
                                    <th style="width: 50px">Var.</th>
                                    <th style="width: 60px">Acc.</th>
                                    <th style="width: 60px">Saldo</th>
                                    <th style="width: 50px">N. Imm</th>
                                    <th style="width: 70px">Cod. Trib</th>
                                    <th style="width: 70px">Rateaz.</th>
                                    <th style="width: 60px">Anno</th>
                                    <th style="width: 110px">Debito (â‚¬)</th>
                                    <th style="width: 110px">Credito (â‚¬)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.imuRows.map((row, i) => `
                                <tr>
                                    <td><input type="text" value="${row.codiceEnte}" oninput="updateData('codiceEnte', this.value, ${i})"></td>
                                    <td><input type="text" value="${row.ravv}" oninput="updateData('ravv', this.value, ${i})"></td>
                                    <td><input type="text" value="${row.immobVariati}" oninput="updateData('immobVariati', this.value, ${i})"></td>
                                    <td><input type="text" value="${row.acconto}" oninput="updateData('acconto', this.value, ${i})"></td>
                                    <td><input type="text" value="${row.saldo}" oninput="updateData('saldo', this.value, ${i})"></td>
                                    <td><input type="number" value="${row.numeroImmobili}" oninput="updateData('numeroImmobili', this.value, ${i})"></td>
                                    <td><input type="text" value="${row.codiceTributo}" oninput="updateData('codiceTributo', this.value, ${i})"></td>
                                    <td><input type="text" value="${row.rateazione}" oninput="updateData('rateazione', this.value, ${i})"></td>
                                    <td><input type="number" value="${row.annoRiferimento}" oninput="updateData('annoRiferimento', this.value, ${i})"></td>
                                    <td><input type="text" class="currency-input" value="${row.importiDebito}" onblur="formatMoney(this, 'importiDebito', ${i})"></td>
                                    <td><input type="text" class="currency-input" value="${row.importiCredito}" onblur="formatMoney(this, 'importiCredito', ${i})"></td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="totals-section">
                    <div class="total-box">
                        <div class="total-label">Totale G</div>
                        <div class="total-value">â‚¬ <span id="displayTotaleG">0,00</span></div>
                    </div>
                    <div class="total-box" style="background: #ecfdf5; border-color: #a7f3d0;">
                        <div class="total-label">Saldo (G-H)</div>
                        <div class="total-value" style="color: #059669;">â‚¬ <span id="displaySaldo">0,00</span></div>
                    </div>
                </div>
            `;
            
            calculateTotals();
        }

        // --- Helper: Format Money Input on Blur ---
        function formatMoney(input, field, rowIndex) {
            let val = Money.parse(input.value);
            let formatted = Money.format(val);
            input.value = formatted;
            updateData(field, formatted, rowIndex);
        }

        // --- Modals & Prompts ---
        function openPromptModal() { document.getElementById('promptModal').classList.add('active'); }
        function closePromptModal() { document.getElementById('promptModal').classList.remove('active'); }
        function openImportModal() { document.getElementById('jsonModal').classList.add('active'); }
        function closeImportModal() { document.getElementById('jsonModal').classList.remove('active'); }

        function copyPromptToClipboard() {
            const el = document.getElementById('promptText');
            el.select();
            el.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(el.value).then(() => {
                showNotification('Prompt copiato!', 'success');
                closePromptModal();
            });
        }

        // --- Import Logic ---
        function processJSON() {
            try {
                const raw = document.getElementById('jsonInput').value;
                const clean = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(clean);
                if (!Array.isArray(parsed)) throw new Error("JSON non valido (deve essere Array)");

                appData = parsed.map(p => {
                    let newP = JSON.parse(JSON.stringify(DEFAULT_PERSON));
                    newP.codiceFiscale = p.codiceFiscale || "";
                    if(p.datiAnagrafici) Object.assign(newP.datiAnagrafici, p.datiAnagrafici);
                    if(p.domicilioFiscale) Object.assign(newP.domicilioFiscale, p.domicilioFiscale);
                    if(Array.isArray(p.imuRows)) {
                        p.imuRows.forEach((row, idx) => { if(idx<4) Object.assign(newP.imuRows[idx], row); });
                    }
                    return newP;
                });

                const sel = document.getElementById('personSelector');
                sel.innerHTML = '';
                appData.forEach((p, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.text = `${p.datiAnagrafici.nome || 'Utente'} ${p.datiAnagrafici.cognome || (idx+1)}`;
                    sel.appendChild(opt);
                });

                renderCurrentPerson();
                closeImportModal();
                showNotification('Dati importati!', 'success');
            } catch (e) { alert("Errore JSON: " + e.message); }
        }

        // --- Export Logic ---
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                if (!appData.length) return showNotification('Nessun dato!', 'error');

                appData.forEach((data, index) => {
                    const wsData = [
                        ['CAMPO', 'VALORE'],
                        ['Codice Fiscale', data.codiceFiscale],
                        ['Cognome', data.datiAnagrafici.cognome],
                        ['Nome', data.datiAnagrafici.nome],
                        ['Data Nascita', data.datiAnagrafici.dataNascita],
                        ['Sesso', data.datiAnagrafici.sesso],
                        ['Comune Nascita', data.datiAnagrafici.comuneNascita],
                        ['', ''],
                        ['DOMICILIO', ''],
                        ['Comune', data.domicilioFiscale.comune],
                        ['Provincia', data.domicilioFiscale.provincia],
                        ['Indirizzo', data.domicilioFiscale.indirizzo],
                        ['', ''],
                        ['IMU SECTION', ''],
                        ['CodEnte', 'Ravv', 'Var', 'Acc', 'Saldo', 'NumImm', 'CodTrib', 'Rateaz', 'Anno', 'Debito', 'Credito']
                    ];

                    data.imuRows.forEach(row => {
                        wsData.push([
                            row.codiceEnte, row.ravv, row.immobVariati, row.acconto, row.saldo, 
                            row.numeroImmobili, row.codiceTributo, row.rateazione, row.annoRiferimento, 
                            row.importiDebito, row.importiCredito
                        ]);
                    });

                    // Calcoli totali per export
                    let tD = 0, tC = 0;
                    data.imuRows.forEach(row => { tD += Money.parse(row.importiDebito); tC += Money.parse(row.importiCredito); });
                    wsData.push(['', '', '', '', '', '', '', '', '', 'TOTALE', Money.format(tD)]);
                    wsData.push(['', '', '', '', '', '', '', '', '', 'SALDO', Money.format(tD - tC)]);

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    let sheetName = `F24_${data.datiAnagrafici.cognome || ('Persona' + (index + 1))}`.substring(0, 31).replace(/[\/\\\?\*\[\]]/g, '');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                XLSX.writeFile(wb, `F24_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
                showNotification('Export completato!', 'success');
            } catch (e) { showNotification('Errore export', 'error'); }
        }

        function resetApp() {
            if(confirm("Cancellare tutto?")) {
                appData = [JSON.parse(JSON.stringify(DEFAULT_PERSON))];
                document.getElementById('personSelector').innerHTML = '<option value="0">Contribuente 1</option>';
                renderCurrentPerson();
                showNotification('Resettato', 'success');
            }
        }

        function showNotification(msg, type) {
            const div = document.createElement('div');
            div.className = `notification ${type} show`;
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2500);
        }

        init();
    </script>
</body>
</html>
